name: Deploy to Firebase and Google Cloud Platform (Dev Environment)

on:
  push:
    branches:
      - dev

jobs:
  build:
    name: Building and Distributing App (Dev)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          version: '3.19.0'

      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: '17'

      - name: Install dependencies
        run: flutter pub get

      - name: Clean Flutter project
        run: flutter clean

      - name: Build Flutter for Android
        run: flutter build appbundle --flavor dev

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Set up Firebase CLI and Authenticate with Service Account
        run: |
          echo "${{ secrets.SERVICE_ACCOUNT_KEY_DEV }}" > $HOME/gcp-key.json
          export GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcp-key.json
          export FIREBASE_PROJECT=${{ secrets.FIREBASE_PROJECT_ID_DEV }}

      - name: Update Firebase CLI
        run: npm install -g firebase-tools@latest

      - name: Upload Artifact to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          serviceCredentialsFileContent: ${{ secrets.SERVICE_ACCOUNT_KEY_DEV }}
          token: ${{ secrets.FIREBASE_TOKEN_DEV }}
          appId: ${{ secrets.FIREBASE_APP_ID_DEV }}
          groups: testers
          file: build/app/outputs/bundle/devRelease/app-dev-release.aab

      - name: Notify on success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: success
          fields: repo,commit
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL_DEV }}
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL_DEV }}
          SLACK_USERNAME: 'Build Info (Dev)'

      - name: Notify on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          fields: repo,commit
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL_DEV }}
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL_DEV }}
          SLACK_USERNAME: 'GitHub Actions (Dev)'
